<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Mysql-InnoDB内部原理浅析 | 箫竹影的博客</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="箫竹影, 箫竹影的博客, java, golang, node.js, javascript, 机器学习, 人工智能呢, 程序员, 前端开发, 服务器开发, 全栈开发, 周禹宏"><meta name="description" content="箫竹影，坐标重庆，java开发渣渣一枚，喜欢钻研各种有趣的技术，但不一定实用；喜欢购买一些高大上的书籍，但不一定会看；喜欢各种个样的运动，但没有任何实战经验；梦想去一次米兰看球，但已不认识现在球队的任何一个人；主张乐观，快乐的工作和生活，喜欢追逐梦想的感觉。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://zhouyuhong.top/2018/02/09/Mysql-InnoDB内部原理浅析/index.html"><link rel="icon" type="image/png" href="http://images-enjoylife.bj.bcebos.com/blog%2Ffavicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="箫竹影"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?8c6377e9263c5a80ba1e5ce58bdeff58";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(http://images-enjoylife.bj.bcebos.com/blog%2Floading.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="箫竹影" alt="箫竹影"><img src="http://images-enjoylife.bj.bcebos.com/blog%2Flogo-left.png" alt="箫竹影"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="http://strugglepages-1253927162.coscd.myqcloud.com/2018-02-09-1K416L26M6BE_111_600.png" alt="Mysql-InnoDB内部原理浅析"></div><header class="post__info"><h1 class="post__title">Mysql-InnoDB内部原理浅析</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://github.com/zhouyuhong">箫竹影</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-02-09</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/mysql/">Mysql</a></li></ul></div></div></header><div class="post__content"><p>MySQL是一个应用非常广泛的开源数据库，同时由于它的逻辑架构十分出色，所以几乎可以用于各行各业中。它的插件式的存储引擎，将查询处理和其他的系统任务、数据存放获取分离开来。所以，用户可以根据自己的业务需要，选择自己适合的存储引擎。</p><hr><p>首先展示一下Mysql的架构图<br><img src="http://strugglepages-1253927162.coscd.myqcloud.com/2018-02-09-mysql%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg" alt=""></p><ol><li><strong>Connection Pool</strong>：该层就是连接层，包含了一些客户端和连接服务，它包含了各种本地SOCKET通信，或者基于服务端/客户端的类TCP/IP的通信。主要负责一些连接管理，权限认证等安全校验。同时，采用线程池的模型，为客户端提供线程访问，并且也支持基于SSL的安全连接机制。</li><li><strong>SQL Interface</strong>，<strong>Parser</strong>，<strong>Optimizer</strong>，<strong>Caches&amp;Buffers</strong>：该层主是处理层，主要负责处理各种操作，例如Sql接口，解析SQL语句，同时优化语句，缓存的存取等功能。在这一层中，Mysql会将我们的SQL语句进行解析，生成解析树，同时会对查询进行优化，判断查询表的先后顺序，是否利用索引等，最后执行优化后的操作。针对select语句，还会去查询缓存，如果缓存足够大，对整个查询的效率也是有质的提升的。当然，一些跨存储引擎的功能，例如存储过程的执行，函数的执行等，也是放在这一层的。</li><li><strong>Plugin Storage Engines</strong>：该层就是我们在顶部提到的插件式存储引擎，这一层就是实际对数据进行存储和获取的一层，服务器通过存储引擎提供的各种API，来进行数据的操作，同时各个存储引擎的功能又有所不同，我们可以根据实际需要进行选择。</li><li><strong>File System</strong>，<strong>File &amp;&amp; Log</strong>：该层就是数据存储层，主要是将我们的数据存入各种设备的文件系统之上，同时负责与存储引擎进行交互。</li><li><strong>Management Services</strong> &amp; <strong>Utilities</strong>：该层是管理服务工具层，这一层主要负责的是Mysql的一些关系服务，例如恢复，备份，集群等操作。</li></ol><hr><p>从上面的架构图上，我们可以看到，plguin engines这一部分就是mysql整个架构图的精华之所在，通过插件式的设计思想，就可以涌生出大量的优秀的存储引擎，常用有myisam以及innoDB两种，那么，接下来，我们就重点介绍一下我们用得最多的InnoDB这个存储引擎。</p><p>####InnoDB：<br>InnoDB是一个优秀的存储引擎，可以支持譬如索引查询，行锁，表锁等特性，故也是大家用得最多的一个存储引擎。那么，InnoDB内部的数据文件又是以什么样的形式存储的呢？这里我们就不得不来介绍一下InnoDB的共享表空间和独立表空间</p><ul><li>共享表空间：即每一个数据库的所有表信息，数据信息，索引信息全部放在一个文件空间里面。</li><li>独立表空间：即每一个数据库的所有表都单独生成对应的文件。每一个表对应两个文件，一个是表的描述，另一个就是表的数据和索引。</li></ul><p><strong>共享表空间优点</strong>：将所有的表数据放在一起，可以方便的进行管理，同时，可以将数据进行分文件存储，也就是说一个表的数据可能分布在多个文件中，每一个文件有着固定的大小限制，但是文件数量可以不断增加，所以，其大小限制不再受文件大小限制而限制，而是以自己本身的数据为准了。<br><strong>共享表空间缺点</strong>：由于所有的索引和数据放在一起，那么当进行大批量删除的时候，必然会造成文件的空间有大量的空隙存在，这样会造成大量的空间浪费，所以特别是日志系统等数据量大并且存放时间不多的系统，就不适宜用共享表空间来做。</p><p><strong>独立表空间有点</strong>：由于各个表的数据分开存放，那么当有大批量删除的时候，就可以对文件进行空间空隙的回收操作了。同时，对于数据的影响性也会更小，因为某一个表的数据有问题，不会影响其他表的数据，并且做数据的物理迁移也很方便，如果我们需要这个库的某一张或某几张表，那么仅仅只需要对这几张表做复制即可。<br><strong>独立表空间缺点</strong>：显然，独立表空间不会把数据放在多个文件中，那么文件大小就成了数据的限制，如果数据量超过文件大小，显然就会对数据造成丢失。</p><hr><p>介绍完了InnoDB的文件存储形式，接下来我们就介绍一下InnoDB所使用到的索引格式。InnoDB中使用的索引通常是b+树和hash两种。但是普遍使用的是b+树。b+树的概念这里不多做介绍，相信你能在网上找到比我更牛逼的大神并通过简单的话语来介绍b+树，这里只是简单的描述一下b+树的基本概念。<br>b+树不再是纯粹的二叉树了，而是被称为<strong>多路搜索树</strong>，其每一个父节点允许拥有多余两个的孩子节点。同时，非叶子结点存放的是索引量，通常是一个范围，只有最后的叶子结点才会存放具体的数据内容。如下图所示就是一个基本的b+树：<br><img src="http://strugglepages-1253927162.coscd.myqcloud.com/2018-02-11-b-%E6%A0%91.jpg" alt=""><br>我们用一个简单的例子来描述一下b+树的搜索流程，假设此时我们要找索引为4的具体数据。</p><ol><li>首先查询根节点，发现4在3～5这个中间，于是便进入它的中间子节点中。</li><li>此时开始继续查询这个节点，发现4正好在这个节点上，并且这个节点是叶子结点，所以就可以直接返回数据了。</li></ol><p>这里额外补充一下，在b+树之前，还有b树，那么b树与b+树又有什么不同呢？既然它们都有一个共同的字母b，那么显然它们的组成结构必定是类似的。下图就是b树的数据结构，同样，它也是<strong>多路搜索树</strong>。<br><img src="http://strugglepages-1253927162.coscd.myqcloud.com/2018-02-11-b%E6%A0%91.png" alt=""><br>其实可以看出，b树与b+树唯一的不同点就是b树的每一个结点都同时存放了数据和索引信息，而b+树的非叶子结点中只会有索引，叶子节点才会有具体的数据。而它的检索方式同b+树。</p><p>那么，既然b树也满足快速查找的目的，为什么还会有b+树呢？其实这就要从操作系统说起了，b+树的磁盘读写代价更低，很简单，假设此时我们有同样的一堆数据，由于b树的每一个结点都存放了索引和数据，所以每一个结点的文件大小必然比b+树大，那么当数据库进行查找时，同样大小的内存空间，读取b树结点数必然要比b+树小，假设固定内存大小，b树可以一次性读取5个节点的内容，那么b+树也许一次就能读取20个。所以如果我们查询的结点数据索引在15号节点上，那么b树就需要读取三次结点，而b+树读取二次就能查询出结果了（一次读取索引，第二次根据索引读取具体的数据）。不过b树也不是完全没有优点，假设此时索引在1号节点上，那么b树第一次就能取到数据，而b+树不得不通过两次读取来获取数据。</p><hr><p>同时，InnoDB内部的索引又分为聚集索引和辅助索引，二者的区别是聚集索引的行数据与主键索引存放在一起的，而辅助索引只存放索引的键数据和主键。</p><p>对于聚集索引而言，是根据主键来进行生成的，所以一张表只能有一个聚集索引，由于聚集索引存放了数据，所以检索效率十分高，而MySQL的查询优化器也会优先靠拢聚集索引。<br>对于辅助索引而言，由于只是存放索引数据和主键，所以通过辅助索引查询到的数据，结果是对应的主键信息，那么此时还需要根据主键信息去聚集索引中查询对应的数据，所以执行效率没有聚集索引高，但是这里也有一点要注意，如果查询优化器发现我们查询的字段正好就是辅助索引的索引键，那么mysql就可以直接返回索引数据作为查询数据，而无需再次查询聚集索引获取数据了。</p><p>所以，根据这个特性，在Mysql的优化查询方案中，就有一种叫做覆盖索引的优化方式，具体就是将我们需要查询的字段生成联合索引，那么根据前面介绍的辅助索引的查询特点，mysql就可以直接通过查询索引文件来返回数据了。</p><div class="post-announce">感谢您的阅读，本文由 <a href="http://zhouyuhong.top">箫竹影</a> 版权所有。如若转载，请注明出处：箫竹影（<a href="http://zhouyuhong.top/2018/02/09/Mysql-InnoDB内部原理浅析/">http://zhouyuhong.top/2018/02/09/Mysql-InnoDB内部原理浅析/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2018/01/14/Zookeeper-Paxos算法理解/" title="Zookeeper-Paxos算法理解"><i class="iconfont icon-prev"></i>Zookeeper-Paxos算法理解</a></div><div class="post__prev post__prev--right"></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">箫竹影，坐标重庆，java开发渣渣一枚，喜欢钻研各种有趣的技术，但不一定实用；喜欢购买一些高大上的书籍，但不一定会看；喜欢各种个样的运动，但没有任何实战经验；梦想去一次米兰看球，但已不认识现在球队的任何一个人；主张乐观，快乐的工作和生活，喜欢追逐梦想的感觉。</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Zookeeper/">Zookeeper</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Mysql/">Mysql</a><span class="block-list-count">2</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/02/09/Mysql-InnoDB内部原理浅析/" title="Mysql-InnoDB内部原理浅析"><div class="item__cover"><img src="http://strugglepages-1253927162.coscd.myqcloud.com/2018-02-09-1K416L26M6BE_111_600.png" alt="Mysql-InnoDB内部原理浅析"></div><div class="item__info"><h3 class="item__title">Mysql-InnoDB内部原理浅析</h3><span class="item__text">2018-02-09</span></div></a></li><li class="latest-post-item"><a href="/2018/01/14/Zookeeper-Paxos算法理解/" title="Zookeeper-Paxos算法理解"><div class="item__cover"><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fngfi15et6j31ks0wedyo.jpg" alt="Zookeeper-Paxos算法理解"></div><div class="item__info"><h3 class="item__title">Zookeeper-Paxos算法理解</h3><span class="item__text">2018-01-14</span></div></a></li><li class="latest-post-item"><a href="/2017/12/29/MySQL主从同步实现原理/" title="Mysql主从同步原理"><div class="item__cover"><img src="http://images-enjoylife.bj.bcebos.com/articles%2FMysql%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86%2Fmysql.jpeg" alt="Mysql主从同步原理"></div><div class="item__info"><h3 class="item__title">Mysql主从同步原理</h3><span class="item__text">2017-12-29</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/mysql/">mysql</a></li><li class="tag-item"><a class="tag-link" href="/tags/zookeeper/">zookeeper</a></li><li class="tag-item"><a class="tag-link" href="/tags/主从同步/">主从同步</a></li><li class="tag-item"><a class="tag-link" href="/tags/分布式/">分布式</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站主要用于分享和交流，欢迎微信扫码与我一起探讨，欢迎点击右下角订阅rss。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Chongqing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>273961736@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="http://images-enjoylife.bj.bcebos.com/blog%2Frss.png" alt="logo" title="箫竹影"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/zhouyuhong" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:273961736@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var tags=["mysql"],gitalk=new Gitalk({clientID:"2fbafc7d21e6ea267a8f",clientSecret:"f7e91b245bbcd441559719a38f4da1aa5a5bc96b",repo:"zhouyuhong.github.io",owner:"zhouyuhong",admin:["zhouyuhong"],labels:tags});gitalk.render("comment-container")</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>