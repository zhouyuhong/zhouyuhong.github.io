<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Mysql主从同步原理 | 箫竹影的博客</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="箫竹影, 箫竹影的博客, java, golang, node.js, javascript, 机器学习, 人工智能呢, 程序员, 前端开发, 服务器开发, 全栈开发, 周禹宏"><meta name="description" content="箫竹影，坐标重庆，java开发渣渣一枚，喜欢钻研各种有趣的技术，但不一定实用；喜欢购买一些高大上的书籍，但不一定会看；喜欢各种个样的运动，但没有任何实战经验；梦想去一次米兰看球，但已不认识现在球队的任何一个人；主张乐观，快乐的工作和生活，喜欢追逐梦想的感觉。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://zhouyuhong.top/2017/12/29/MySQL主从同步实现原理/index.html"><link rel="icon" type="image/png" href="http://images-enjoylife.bj.bcebos.com/blog%2Ffavicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="箫竹影"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?8c6377e9263c5a80ba1e5ce58bdeff58";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(http://images-enjoylife.bj.bcebos.com/blog%2Floading.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="箫竹影" alt="箫竹影"><img src="http://images-enjoylife.bj.bcebos.com/blog%2Flogo-left.png" alt="箫竹影"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="http://images-enjoylife.bj.bcebos.com/articles%2FMysql%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86%2Fmysql.jpeg" alt="Mysql主从同步原理"></div><header class="post__info"><h1 class="post__title">Mysql主从同步原理</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://github.com/zhouyuhong">箫竹影</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2017-12-29</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/mysql/">Mysql</a></li><li class="mark__item"><a href="/tags/主从同步/">主从同步</a></li></ul></div></div></header><div class="post__content"><p>mysql的主从同步给构建大型系统带来了无限的可能性，接下来我们就简单介绍一下mysql的主动同步的基本原理以及实现方式。</p><hr><h3 id="什么是主从同步"><a href="#什么是主从同步" class="headerlink" title="什么是主从同步"></a>什么是主从同步</h3><p>在mysql集群这个体系中，mysql会单独拿出一台机器作为主机器master，我们所有的insert，update，delete操作全部都在这台master服务器的库上，然后其他的机器全部作为这台机去的从节点slave，从节点的mysql会去master机器上获取最近一段时间的操作（通常很短暂），然后同步更新自己的数据，这样就达到了主从同步的操作。</p><p>这样的不同于传统的单机操作模式，带来的好处就是可以实现读写分离，集群扩展，数据的分区容错和高可用，数据备份等。</p><h3 id="主从同步实现方式"><a href="#主从同步实现方式" class="headerlink" title="主从同步实现方式"></a>主从同步实现方式</h3><p>那么，mysql是通过怎样的一种方式来实现主从同步的呢？其实很简单，在mysql内部，会有一个特殊的文件来记录着master上发生的一切，这个文件被叫做binary-log，俗称bin-log，这个文件所记录的操作被成为主从同步事件，每一个事件代表着一系列的intert，update，delete等操作，总体上，主从同步事件又大致分为三种：</p><ul><li>statement 即master上执行的所有sql语句会被完整的记录到bin-log中</li><li>row 即每一条记录的变化情况会被记录到bin-log中</li><li>mix 即同时混合前面的两种事件，结合使用</li></ul><p>当slave机器连接到master机器上时，master机器会开启一个叫做bin-dump的线程来管理这一个连接，当master的bin-log有改变的时候，dump线程会通知slave机器，同时将自己的更新内容同步给slave机器节点中。所以，一主多从下，master会有多个dump线程来维护多个slave服务器</p><p>同时，slave机器自身也会开启两个线程，一个叫做io线程，一个叫做sql线程，具体操作过程如下：</p><ul><li>io线程：接受master返回的bin-log中的更新内容，记录到本地的一个叫做中继日志中(relay.log)，当同步完成后，它会休眠，直到下一次master有更新时，通知它。</li><li>sql线程：从中继日志中获取最新的改变内容，然后在本地同步执行这些操作。这里有一个限制：master上可能有许多不影响的操作，它会并行执行，但是slave在同步这些操作时，只会串行化的执行这些操作。</li></ul><p>通过在master上执行命令可以查看当前master的dump线程：<br><img src="http://images-enjoylife.bj.bcebos.com/articles%2FMysql%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86%2Fmysql%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A51.png" alt="Alt mysql master dump线程"></p><p>当然，在slave上执行命令也可以查看自己的io线程和sql线程：<br><img src="http://images-enjoylife.bj.bcebos.com/articles%2FMysql%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86%2Fmysql%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A52.png" alt="Alt mysql slave io与sql线程"><br>从sql线程中我们可以看到确实是从一个叫relay.log中获取同步操作的。</p><h3 id="扩展slave节点"><a href="#扩展slave节点" class="headerlink" title="扩展slave节点"></a>扩展slave节点</h3><p>通常一个业务最开始都是从单机逐渐到集群的，所以mysql也是一样，我们很少有一开始就设置主从架构的应用，那么，如何在一个已有的服务器中添加从机器，或者从某一个已经有主从架构的服务商扩展一个新的slave呢？其实大致会有如下的几种方式：</p><ul><li>冷拷贝方式：即停止掉master节点，先进行数据复制，然后再启动，显然，这不是一个好的方案。</li><li>热拷贝方式：如果你是使用的myisam的存储引擎，那么你可以使用mysqlhotcopy程序来实现拷贝操作。</li><li>使用mysqldump方式：此时如果我们没有用myisam引擎，那么我们就可以通过dump来实现不停服务的情况下进行数据的拷贝，它的大致流程有如下三步：<br>1.锁表，我们知道，如果想保证数据一致，那么在进行复制时，锁表就是必须的一个步骤。<br>2.创建dump线程，执行数据同步操作。<br>3.释放表。</li></ul><h3 id="5-7新增的并行复制"><a href="#5-7新增的并行复制" class="headerlink" title="5.7新增的并行复制"></a>5.7新增的并行复制</h3><p>从前面的步骤我们可以分析出一个结论，就是复制的过程必然会导致大量延迟（这也是确实存在的），所以mysql从5.6开始，就在全力解决这个棘手的问题，5.6之后，mysql提出了一个并行复制的概念，即可以同时进行数据的备份，用于减少延迟，大致上来说，5.6的mysql是基于schema的并行复制策略，所以这种场景下其实是有一个弊端的，我们知道，mysql中，每一个schema可以理解为一个库，所以基于schema就意味着可以实现多个库的并行复制，但是我们平常大多数时候，一个项目通常只会有一个库，所以单库下，我们并不能使用mysql的并行复制功能。</p><p>而mysql 5.7开始，从新引入一个叫gtids的概念，即全局事务id，所以说这一个版本开始，就是基于事务的复制了，这样就解决了单库的问题。</p><div class="post-announce">感谢您的阅读，本文由 <a href="http://zhouyuhong.top">箫竹影</a> 版权所有。如若转载，请注明出处：箫竹影（<a href="http://zhouyuhong.top/2017/12/29/MySQL主从同步实现原理/">http://zhouyuhong.top/2017/12/29/MySQL主从同步实现原理/</a>）</div><div class="post__prevs"><div class="post__prev"></div><div class="post__prev post__prev--right"><a href="/2018/01/14/Zookeeper-Paxos算法理解/" title="Zookeeper-Paxos算法理解">Zookeeper-Paxos算法理解<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">箫竹影，坐标重庆，java开发渣渣一枚，喜欢钻研各种有趣的技术，但不一定实用；喜欢购买一些高大上的书籍，但不一定会看；喜欢各种个样的运动，但没有任何实战经验；梦想去一次米兰看球，但已不认识现在球队的任何一个人；主张乐观，快乐的工作和生活，喜欢追逐梦想的感觉。</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/Zookeeper/">Zookeeper</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Mysql/">Mysql</a><span class="block-list-count">1</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/01/14/Zookeeper-Paxos算法理解/" title="Zookeeper-Paxos算法理解"><div class="item__cover"><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fngfi15et6j31ks0wedyo.jpg" alt="Zookeeper-Paxos算法理解"></div><div class="item__info"><h3 class="item__title">Zookeeper-Paxos算法理解</h3><span class="item__text">2018-01-14</span></div></a></li><li class="latest-post-item"><a href="/2017/12/29/MySQL主从同步实现原理/" title="Mysql主从同步原理"><div class="item__cover"><img src="http://images-enjoylife.bj.bcebos.com/articles%2FMysql%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86%2Fmysql.jpeg" alt="Mysql主从同步原理"></div><div class="item__info"><h3 class="item__title">Mysql主从同步原理</h3><span class="item__text">2017-12-29</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/mysql/">mysql</a></li><li class="tag-item"><a class="tag-link" href="/tags/zookeeper/">zookeeper</a></li><li class="tag-item"><a class="tag-link" href="/tags/主从同步/">主从同步</a></li><li class="tag-item"><a class="tag-link" href="/tags/分布式/">分布式</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站主要用于分享和交流，欢迎微信扫码与我一起探讨，欢迎点击右下角订阅rss。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Chongqing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>273961736@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="http://images-enjoylife.bj.bcebos.com/blog%2Frss.png" alt="logo" title="箫竹影"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/zhouyuhong" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:273961736@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var tags=["mysql","主从同步"],gitalk=new Gitalk({clientID:"2fbafc7d21e6ea267a8f",clientSecret:"f7e91b245bbcd441559719a38f4da1aa5a5bc96b",repo:"zhouyuhong.github.io",owner:"zhouyuhong",admin:["zhouyuhong"],labels:tags});gitalk.render("comment-container")</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>